# Veles Backtests Tools

Набор инструментов, упрощающих работу с бэктестами на [veles.finance](https://veles.finance/). Все рабочие панели доступны в собственном UI расширения и работают поверх официального API без непосредственного вмешательства в DOM сайта.

## Возможности
- **Мультизапуск бэктестов** — в несколько кликов формирует очередь по списку ботов и валют, автоматически подставляет комиссии, период и отслеживает прогресс.
- **Подхват параметров** — значения комиссий, даты и режимов подтягиваются с сервера, поэтому интерфейс всегда синхронизирован с настройками бота.
- **Сохранение пресетов** — выбранные валюты и задержки сохраняются локально и подставляются при следующем запуске.
- **Агрегация результатов** — раздел «Бэктесты» показывает суммарные показатели выбранных тестов, строит распределение одновременных позиций и позволяет быстро исключать тесты из сводки.

## Структура расширения
- `extension/ui` — основное React-приложение (Vite + TypeScript), собирающее UI и странички.
- `extension/scripts/background.js` — сервис-воркер, проксирующий запросы к вкладке veles.finance и отслеживающий состояние соединения.
- `extension/scripts/proxy-bridge.js` + `extension/scripts/page-fetch-bridge.js` — связка для выполнения запросов от имени авторизованной вкладки.
- `extension/scripts/popup.js` — минимальный попап, открывающий UI в новой вкладке.

Прочие файлы (например, `extension/content-styles.css`, `extension/scripts/aggregator.js`, `extension/scripts/multi-runner.js`) больше не используются и удалены.

## Установка
1. Склонируйте или обновите репозиторий на рабочей машине.
2. Откройте Chrome и перейдите в `chrome://extensions/`.
3. Включите «Режим разработчика» (Developer mode) в правом верхнем углу.
4. Нажмите «Загрузить распакованное» (Load unpacked) и выберите папку `extension` из корня репозитория.
5. Убедитесь, что расширение активировано.

## Как пользоваться
### Интерфейс расширения
1. Авторизуйтесь на veles.finance в обычной вкладке браузера.
2. Откройте всплывающее окно расширения и нажмите «Открыть рабочую панель» — UI откроется в новой вкладке.
3. Используйте навигацию слева, чтобы переключаться между разделами Home, Bots, Import, Backtests.

### Мультизапуск последовательных бэктестов
1. В разделе Bots выберите нужных ботов и откройте модалку запуска.
2. Укажите период, задержку и список дополнительных валют (для мультивалютного режима).
3. Запустите очередь. Прогресс, лог и статус каждого бэктеста отображаются в модалке в режиме реального времени.

### Агрегация результатов бэктестов
1. Перейдите в раздел Backtests. Таблица подтянет последние бэктесты через API veles.finance.
2. Отметьте интересующие бэктесты и нажмите «Собрать статистику».
3. После загрузки строку можно временно исключать из сводки: снимите чекбокс «В статистике» рядом с записью.
4. Сводные карточки и график пересчитываются мгновенно — используйте их, чтобы подобрать лимиты одновременно открытых позиций и оценить совокупные метрики.

## Проверка
- Загрузите расширение в режиме разработчика и убедитесь, что UI открывается из попапа без ошибок.
- Для мультизапуска запустите очередь на тестовом боте. В DevTools (`Network` → фильтр `backtests`) должны появиться запросы `POST /api/backtests/` с кодом 200.
- Для агрегации отметьте несколько строк, соберите статистику и проверьте, что график и карточки реагируют на включение/выключение строк.
- При ошибках 403 убедитесь, что авторизация на veles.finance активна.

## Разработка
- UI живёт в `extension/ui` и собирается обычным `npm run dev|build` (Vite + React + TypeScript).
- Сервис-воркер и мосты в `extension/scripts` отвечают за проксирование запросов и обновление статуса соединения. Добавляя новую функциональность, регистрируйте сообщения в `background.js`.

### Запуск тестов
Проект использует [Vitest](https://vitest.dev/) для автоматического тестирования.

```bash
# Запуск тестов один раз
npm test

# Запуск тестов в режиме watch (автоперезапуск при изменении файлов)
npm run test:watch

# Запуск тестов с UI интерфейсом
npm run test:ui

# Запуск тестов с отчётом покрытия кода
npm run test:coverage
```

Тесты находятся рядом с тестируемыми модулями в файлах `*.test.ts` или `*.spec.ts`.
