# Veles Backtests Tools

Набор инструментов, упрощающих работу с бэктестами на [veles.finance](https://veles.finance/). Расширение умеет массово запускать бэктесты по списку инструментов и агрегировать результаты уже выполненных тестов.

## Возможности
- **Мультизапуск бэктестов** — отдельная панель в модалке запуска, которая автоматически подтягивает текущего бота, подставляет задержку и отображает прогресс очереди.
- **Подхват параметров страницы** — комиссии, учёт теней и выбранный период берутся из активной формы, а ID бота и котируемая валюта определяются автоматически.
- **Сохранение настроек** — список тикеров и задержка между запросами сохраняются в `localStorage` и подставляются при следующем открытии панели.
- **Агрегация результатов** — дополнительная панель на странице истории бэктестов, которая позволяет выбрать набор тестов, загрузить их статистику и получить суммарные метрики (P&L, просадки, дни без торговли без единого активного ордера, количество сделок и т.д.) с цветовой подсветкой положительных/отрицательных значений.

## Структура расширения
- `extension/scripts/bootstrap.js` — защита от повторной инициализации и подготовка пространства имён.
- `extension/scripts/multi-runner.js` — логика мультизапуска: работа с модалкой, очередь бэктестов, прогресс и лог.
- `extension/scripts/aggregator.js` — сбор и агрегация статистики уже выполненных бэктестов.
- `extension/scripts/init.js` — общий вход: вызывает инициализацию модулей после загрузки DOM.
- `extension/content-styles.css` — оформление панелей мультизапуска и агрегации.

## Установка
1. Склонируйте или обновите репозиторий на рабочей машине.
2. Откройте Chrome и перейдите в `chrome://extensions/`.
3. Включите «Режим разработчика» (Developer mode) в правом верхнем углу.
4. Нажмите «Загрузить распакованное» (Load unpacked) и выберите папку `extension` из корня репозитория.
5. Убедитесь, что расширение активировано.

## Как пользоваться
### Мультизапуск последовательных бэктестов
1. Авторизуйтесь на veles.finance и откройте страницу `https://veles.finance/cabinet/backtests` или карточку нужного бота.
2. Нажмите кнопку «Мультизапуск» в модалке запуска бэктеста. Появится панель с текстовым полем для тикеров и настройкой задержки.
3. Введите базовые тикеры без второй валюты (`BTC`, `ETH`, `SOL` и т.д.) — каждый на новой строке. Вторая валюта берётся из текущей стратегии.
4. При необходимости скорректируйте задержку. Минимально допустимое значение — 5 секунд.
5. Запустите очередь. Расширение последовательно клонирует стратегию для каждой пары, подставляет комиссии и параметры периода из формы, отправляет запросы и ведёт лог. Кнопка превращается в «Остановить», чтобы можно было досрочно завершить выполнение.

### Агрегация результатов бэктестов
1. Перейдите на страницу истории бэктестов (`/cabinet/backtests`). Панель агрегации появится под таблицей с тестами.
2. Отметьте галочками интересующие бэктесты в исходной таблице или воспользуйтесь чекбоксами панели.
3. Нажмите «Агрегировать результаты». Расширение запросит детали по каждому выбранному тесту и заполнит таблицу резюме: суммарный P&L, сделки, просадки, суммарные дни без торговли (когда не открыт ни один ордер ни по одному боту), МПУ и другие метрики.
4. Используйте лог панели, чтобы отслеживать ход загрузки и возможные ошибки.

## Проверка
- Загрузите расширение в режиме разработчика и откройте страницу бэктестов.
- Для мультизапуска введите 1–2 тикера и запустите очередь. В DevTools (`Network` → фильтр `backtests`) должны появиться запросы `POST /api/backtests/` с кодом 200.
- Для агрегации отметьте несколько строк и выполните сбор статистики. В сетевых запросах появятся обращения к `api/backtests/statistics`, а панель заполнится новыми данными, включая «дни без торговли» и подсвеченные значения P&L/просадок.
- При ошибках 403 убедитесь, что авторизация действительна и на странице присутствует мета-тег `_csrf`.

## Разработка
- Основная логика разбита по модулям в `extension/scripts`. Подключение новых функций делайте через отдельные файлы и не забывайте добавить их в `manifest.json`.
- Перед изменениями UI обновляйте `extension/content-styles.css`, чтобы обе панели оставались визуально консистентными.
- Если на стороне veles.finance изменится API, правки вносите в соответствующий модуль (`multi-runner.js` для запуска, `aggregator.js` для статистики).
